<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Real-time Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Add a simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div 
        x-data="objectDetector()" 
        x-init="init()"
        class="container mx-auto p-4 max-w-2xl"
    >
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">リアルタイム物体検知</h1>

        <!-- Controls -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label for="target-select" class="font-bold">ターゲット:</label>
                <select 
                    id="target-select" 
                    x-model="selectedTarget"
                    class="p-2 border rounded-md"
                >
                    <option value="smartphone">スマホ</option>
                    <option value="bear">熊</option>
                    <option value="laptop">ラップトップ</option>
                    <option value="pen">ペン</option>
                    <option value="screwdriver">ドライバー</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <button 
                    @click="startCamera" 
                    :disabled="isCameraOn" 
                    class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md disabled:bg-gray-400"
                >
                    カメラON
                </button>
                <button 
                    @click="stopCamera" 
                    :disabled="!isCameraOn" 
                    class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md disabled:bg-gray-400"
                >
                    カメラOFF
                </button>
            </div>
        </div>

        <!-- Video and Image Display -->
        <div class="bg-white p-4 rounded-lg shadow-md relative min-h-[480px] flex items-center justify-center">
            <video x-ref="video" class="absolute top-0 left-0 w-full h-full" style="display: none;" playsinline></video>
            
            <img x-ref="image" src="" class="w-full h-auto rounded-md" />

            <div x-show="isLoading" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <div class="loader"></div>
            </div>
             <p x-show="!isCameraOn && !image.src" class="text-gray-500">カメラを開始してください</p>
        </div>
    </div>

    <script>
    function objectDetector() {
        return {
            isLoading: false,
            isCameraOn: false,
            stream: null,
            selectedTarget: 'smartphone',
            video: null,
            image: null,
            lastFrameTime: 0,
            frameInterval: 300, // ms, approx 3.3 FPS

            init() {
                this.video = this.$refs.video;
                this.image = this.$refs.image;
            },

            async startCamera() {
                if (this.isCameraOn) return;
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    this.video.srcObject = this.stream;
                    this.video.play();
                    this.isCameraOn = true;
                    this.image.style.display = 'block'; // Show the img tag
                    this.video.style.display = 'none'; // Keep video hidden, we use it as a source
                    
                    requestAnimationFrame(this.predictFrame.bind(this));

                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("カメラにアクセスできませんでした。権限を確認してください。");
                }
            },

            stopCamera() {
                if (!this.isCameraOn) return;
                this.stream.getTracks().forEach(track => track.stop());
                this.isCameraOn = false;
                this.image.src = '';
                this.image.style.display = 'none';
            },

            async predictFrame(timestamp) {
                if (!this.isCameraOn) return;

                if (timestamp - this.lastFrameTime < this.frameInterval) {
                    requestAnimationFrame(this.predictFrame.bind(this));
                    return;
                }
                this.lastFrameTime = timestamp;

                if (this.isLoading) {
                    requestAnimationFrame(this.predictFrame.bind(this));
                    return;
                }

                this.isLoading = true;

                const canvas = document.createElement('canvas');
                canvas.width = this.video.videoWidth;
                canvas.height = this.video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(this.video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('target', this.selectedTarget);
                    formData.append('image_blob', blob, 'frame.jpg');

                    try {
                        const response = await fetch('/predict_stream', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error(`Server error: ${response.statusText}`);
                        }

                        const data = await response.json();
                        this.image.src = data.image;

                    } catch (error) {
                        console.error('Prediction error:', error);
                        // Optionally stop camera on error
                        // this.stopCamera();
                    } finally {
                        this.isLoading = false;
                        if (this.isCameraOn) {
                            requestAnimationFrame(this.predictFrame.bind(this));
                        }
                    }
                }, 'image/jpeg');
            }
        }
    }
    </script>
</body>
</html>
